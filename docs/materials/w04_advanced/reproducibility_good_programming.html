<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Michael Hallquist">
<meta name="dcterms.date" content="2026-02-13">

<title>How good programming practices support scientific reproducibility – Data Management and Visualization</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-203898e0a995a1603b190edd51f3a64a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../rmd_style.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">PSYC 859</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Overview</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../syllabus.html"> 
<span class="menu-text">Syllabus</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../materials.html"> 
<span class="menu-text">Materials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../assignments.html"> 
<span class="menu-text">Assignments</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#thesis" id="toc-thesis" class="nav-link" data-scroll-target="#thesis">Thesis</a>
  <ul class="collapse">
  <li><a href="#the-value-of-functional-programming" id="toc-the-value-of-functional-programming" class="nav-link" data-scroll-target="#the-value-of-functional-programming">The value of functional programming</a></li>
  </ul></li>
  <li><a href="#motivating-example-diagnosing-and-making-decisions-about-head-movement-in-fmri" id="toc-motivating-example-diagnosing-and-making-decisions-about-head-movement-in-fmri" class="nav-link" data-scroll-target="#motivating-example-diagnosing-and-making-decisions-about-head-movement-in-fmri">Motivating example: diagnosing and making decisions about head movement in fMRI</a></li>
  <li><a href="#key-steps-in-thinking-about-a-data-problem" id="toc-key-steps-in-thinking-about-a-data-problem" class="nav-link" data-scroll-target="#key-steps-in-thinking-about-a-data-problem">Key steps in thinking about a data problem</a></li>
  <li><a href="#define-the-scope" id="toc-define-the-scope" class="nav-link" data-scroll-target="#define-the-scope">1. Define the scope</a>
  <ul class="collapse">
  <li><a href="#scope-what-datafiles-do-we-need" id="toc-scope-what-datafiles-do-we-need" class="nav-link" data-scroll-target="#scope-what-datafiles-do-we-need">Scope: what data/files do we need?</a></li>
  <li><a href="#scope-what-computations-are-needed" id="toc-scope-what-computations-are-needed" class="nav-link" data-scroll-target="#scope-what-computations-are-needed">Scope: what computations are needed?</a></li>
  </ul></li>
  <li><a href="#whats-the-structure-of-the-data" id="toc-whats-the-structure-of-the-data" class="nav-link" data-scroll-target="#whats-the-structure-of-the-data">2. What’s the structure of the data?</a>
  <ul class="collapse">
  <li><a href="#tracking-down-files" id="toc-tracking-down-files" class="nav-link" data-scroll-target="#tracking-down-files">Tracking down files</a></li>
  </ul></li>
  <li><a href="#articulate-the-desired-outputs-and-define-success" id="toc-articulate-the-desired-outputs-and-define-success" class="nav-link" data-scroll-target="#articulate-the-desired-outputs-and-define-success">3. Articulate the desired outputs and define success</a></li>
  <li><a href="#define-the-importance-of-the-problem-and-the-level-of-your-investment-how-mission-critical-is-this" id="toc-define-the-importance-of-the-problem-and-the-level-of-your-investment-how-mission-critical-is-this" class="nav-link" data-scroll-target="#define-the-importance-of-the-problem-and-the-level-of-your-investment-how-mission-critical-is-this">4. Define the importance of the problem and the level of your investment: how mission critical is this?</a></li>
  <li><a href="#prototype-the-process-get-this-working-for-one-test-case." id="toc-prototype-the-process-get-this-working-for-one-test-case." class="nav-link" data-scroll-target="#prototype-the-process-get-this-working-for-one-test-case.">5. Prototype the process: get this working for one test case.</a>
  <ul class="collapse">
  <li><a href="#get-the-mean" id="toc-get-the-mean" class="nav-link" data-scroll-target="#get-the-mean">get the mean</a></li>
  <li><a href="#get-the-max" id="toc-get-the-max" class="nav-link" data-scroll-target="#get-the-max">get the max</a></li>
  <li><a href="#how-many-fd-values-are-0.3mm" id="toc-how-many-fd-values-are-0.3mm" class="nav-link" data-scroll-target="#how-many-fd-values-are-0.3mm">how many FD values are &gt; 0.3mm?</a></li>
  <li><a href="#is-the-subject-irreparable-by-my-criteria" id="toc-is-the-subject-irreparable-by-my-criteria" class="nav-link" data-scroll-target="#is-the-subject-irreparable-by-my-criteria">Is the subject ‘irreparable’ by my criteria?</a></li>
  </ul></li>
  <li><a href="#validate-the-outputs-of-your-prototype-do-the-programmatic-processes-and-calculations-match-your-hand-checks" id="toc-validate-the-outputs-of-your-prototype-do-the-programmatic-processes-and-calculations-match-your-hand-checks" class="nav-link" data-scroll-target="#validate-the-outputs-of-your-prototype-do-the-programmatic-processes-and-calculations-match-your-hand-checks">6. Validate the outputs of your prototype: do the programmatic processes and calculations match your hand checks?</a></li>
  <li><a href="#scale-it-up-run-this-process-on-all-examplesiterations" id="toc-scale-it-up-run-this-process-on-all-examplesiterations" class="nav-link" data-scroll-target="#scale-it-up-run-this-process-on-all-examplesiterations">7. Scale it up: run this process on all examples/iterations</a>
  <ul class="collapse">
  <li><a href="#using-the-participant-info-to-guide-us" id="toc-using-the-participant-info-to-guide-us" class="nav-link" data-scroll-target="#using-the-participant-info-to-guide-us">Using the participant info to guide us</a></li>
  <li><a href="#writing-a-worker-function" id="toc-writing-a-worker-function" class="nav-link" data-scroll-target="#writing-a-worker-function">Writing a worker function</a></li>
  </ul></li>
  <li><a href="#make-the-process-self-healing-expect-problems-and-handle-failures-gracefully" id="toc-make-the-process-self-healing-expect-problems-and-handle-failures-gracefully" class="nav-link" data-scroll-target="#make-the-process-self-healing-expect-problems-and-handle-failures-gracefully">8. Make the process self-healing: expect problems and handle failures gracefully</a>
  <ul class="collapse">
  <li><a href="#defining-expected-inputs-and-what-to-do-about-failures" id="toc-defining-expected-inputs-and-what-to-do-about-failures" class="nav-link" data-scroll-target="#defining-expected-inputs-and-what-to-do-about-failures">Defining expected inputs and what to do about failures</a></li>
  <li><a href="#more-flexible-error-trapping-using-trycatch" id="toc-more-flexible-error-trapping-using-trycatch" class="nav-link" data-scroll-target="#more-flexible-error-trapping-using-trycatch">More flexible error trapping using tryCatch</a></li>
  </ul></li>
  <li><a href="#validate-the-global-outputs-how-will-you-know-that-the-overall-process-has-succeeded" id="toc-validate-the-global-outputs-how-will-you-know-that-the-overall-process-has-succeeded" class="nav-link" data-scroll-target="#validate-the-global-outputs-how-will-you-know-that-the-overall-process-has-succeeded">9. Validate the global outputs: how will you know that the overall process has succeeded?</a></li>
  <li><a href="#review-the-pipeline-document-key-decisions-and-consider-refactoring-steps-based-on-what-youve-learned" id="toc-review-the-pipeline-document-key-decisions-and-consider-refactoring-steps-based-on-what-youve-learned" class="nav-link" data-scroll-target="#review-the-pipeline-document-key-decisions-and-consider-refactoring-steps-based-on-what-youve-learned">10. Review the pipeline, document key decisions, and consider refactoring steps based on what you’ve learned</a>
  <ul class="collapse">
  <li><a href="#code-readability" id="toc-code-readability" class="nav-link" data-scroll-target="#code-readability">Code readability</a></li>
  <li><a href="#documentation" id="toc-documentation" class="nav-link" data-scroll-target="#documentation">Documentation</a></li>
  <li><a href="#refactoring" id="toc-refactoring" class="nav-link" data-scroll-target="#refactoring">Refactoring</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">How good programming practices support scientific reproducibility</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Michael Hallquist </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 13, 2026</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
body{ font-size: 20px; max-width: 1800px; margin: auto; padding: 1em; }
code.r{ font-size: 21px; }
pre { font-size: 20px; }
pre code, pre, code {
  white-space: pre !important;
  overflow-x: scroll !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}
</style>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>Warning: untar(compressed=) is deprecated</code></pre>
</div>
</div>
<p>Variable definitions that control algorithmic decisions below. These are placed here to draw our attention to them – if we wish to change our decisions throughout the pipeline, these can be adjusted, rather than having to hunt them down below.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#parameters that control our algorithmic decisions about what constitutes bad head motion</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">#we put these here to draw our attention to </span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>fd_spike_mm <span class="ot">&lt;-</span> <span class="fl">0.3</span> <span class="co">#movement greater than this threshold (in mm) is considered a movement spike</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>p_spikes_cutoff <span class="ot">&lt;-</span> <span class="fl">0.2</span> <span class="co">#if there are more than this proportion of spikes (based on fd_spike_mm), exclude the subject</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>fd_max_mm <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co">#any movement greater than this amount should lead the subject to be excluded</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>One of the most important skills you learn along the data science path is not specific to R, but is crucial to solving data problems. People have called this different things such as “thinking algorithmically”, “thinking like an engineer”, or “solving problems like a computer programmer.” If you’re not an expert on algorithms and are neither a computer scientist nor an engineer, you might ask “what does this really mean?” The answer is hard to convey conceptually, but instead depends heavily on the experiences you accrue as you solve data problems.</p>
<p>My goal here is to convey some of the lessons I’ve learned over the past 10 years and give you an approximate framework for solving data management and analysis problems that extend beyond the basics of the data wrangling and programming.</p>
</section>
<section id="thesis" class="level1">
<h1>Thesis</h1>
<p>One of the greatest threats to reproducible science is the use of data analysis scripts that are poorly organized, poorly documented, and that reflect the sometimes unpredictable sequence of decisions made by the scientist. If it seems hacky, it probably is hacky – and may not be reproducible!</p>
<p>When we solve analysis problems using code, we often begin by hacking our way through the forest. Each step is solved sequentially without necessarily anticipating or representing the additional steps that lie ahead. In part, this is inevitable. We cannot easily predict the complexity of the problem or the intermediate solutions we will test. Therefore, we may make decisions about how to handle a problem, only to reverse on our approach later on. One difficulty is that we may not ‘undo’ all of our earlier steps, or we may suffer from copy-paste errors in the code that lead to inconsistencies in the solution. These human errors are inevitable, but very threatening to reproducibility. Therefore, we need to implement programming practices that mitigate the risk of code yielding unexpected, invalid, or unpredictable results.</p>
<p>Literate programming documents like R Markdown and Jupyter notebooks make the flow of an analysis more accessible, but they do not necessarily support good practices in coding that make code less vulnerable to mistakes.</p>
<p><strong>Corollary</strong>: The more complex the problem, the more we must test each piece of the pipeline as we scale up from prototype to general solution.</p>
<section id="the-value-of-functional-programming" class="level2">
<h2 class="anchored" data-anchor-id="the-value-of-functional-programming">The value of functional programming</h2>
<p>One of the greatest assets to reproducible (data) science is the use of programming paradigms that enforce good practices. In particular, functional programming, in which we view data analysis as a set of predictable transformation functions, supports a clearheaded approach to data problems that blocks many programming crutches.</p>
<p>When we write functions, they demand that we provide specific <em>inputs</em> (arguments) and we demand that the function produce a predictable set of <em>outputs</em>. This should be an unbreakable covenant that leads us to trust functions – and in a way, to forget how they work – <em>after</em> we have validated that they work as expected.</p>
<p>Functions should <em>validate</em> their inputs. For example, if we are expecting a set of time codes for when events happened in the experiment, times should not be negative! Or, if the function is expecting a 2D matrix and we pass in a vector, what should happen?</p>
</section>
</section>
<section id="motivating-example-diagnosing-and-making-decisions-about-head-movement-in-fmri" class="level1">
<h1>Motivating example: diagnosing and making decisions about head movement in fMRI</h1>
<p>I know most of you aren’t in the neuroimaging world, and my goal isn’t to confuse you with all of the details (as people like to say, “it’s complicated”). And the example is not intended to pitch to the imaging crowd, but instead to demonstrate a real-world data problem that has parallels to many other data types (behavior during experiments, self-reports distributed across files and folders, etc.).</p>
<p>With regard to fMRI, I’ll simply convey that head movement during a scan is a huge bugaboo because it fundamentally corrupts the signal. To wit:</p>
<p><img src="../files/fmri_movement.png" class="img-fluid" style="width:50.0%"></p>
<p>There are different ways to mitigate the problem, but suffice it to say that we need to a) know how bad it is, b) detect and potentially remove motion ‘spikes’ from analyses, and c) consider whether to discard someone altogether if the motion is bad enough. We quantify head movement in fMRI by looking at how much the brain moves from image to image (over time). A common metric is called ‘framewise displacement’ (FD), which is an approximation of how much the head moved in any way/direction, measured in millimeters. So that’s what we’ll be working on…</p>
</section>
<section id="key-steps-in-thinking-about-a-data-problem" class="level1">
<h1>Key steps in thinking about a data problem</h1>
<p>We’ll focus here on data problems that have multiple, often repetitive, steps. This problem will also involve tracking down and reading files from many different directories, where the directories are organized by subject (plus additional subdirectories).</p>
<ol type="1">
<li>Define the scope: what are the necessary inputs, including files, variables, and calculations</li>
<li>Get to know the structure of the data: how wonky is it? Do you need to collect files? Does it need to be tidied?</li>
<li>Articulate the desired outputs: how would you know if this problem were solved?</li>
<li>Define the importance of the problem and the level of your investment: how mission critical is this?</li>
<li>Prototype the process: get this working for one test case.</li>
<li>Validate the outputs of your prototype: do the programmatic processes and calculations match your hand checks?</li>
<li>Scale it up: run this process on all examples/iterations</li>
<li>Make the process self-healing: expect problems and handle failures gracefully</li>
<li>Validate the global outputs: how will you know that the overall process has succeeded?</li>
<li>Review the pipeline, document key decisions, and consider refactoring steps based on what you’ve learned</li>
</ol>
</section>
<section id="define-the-scope" class="level1">
<h1>1. Define the scope</h1>
<p>The FD metric is written to a .txt file in every subject’s processed data directory. It lives in the motion_info folder.</p>
<p>It looks like this:</p>
<pre><code>MMClock/
└── MR_Proc
├── 10637_20140304
│&nbsp;&nbsp; └── mni_aroma_minimal_fsl
│&nbsp;&nbsp;     └── rest1
│&nbsp;&nbsp;         └── motion_info
│&nbsp;&nbsp;             └── fd.txt
├── 10638_20140507
│&nbsp;&nbsp; └── mni_aroma_minimal_fsl
│&nbsp;&nbsp;     └── rest1
│&nbsp;&nbsp;         └── motion_info
│&nbsp;&nbsp;             └── fd.txt
├── 10662_20140415
│&nbsp;&nbsp; └── mni_aroma_minimal_fsl
│&nbsp;&nbsp;     └── rest1
│&nbsp;&nbsp;         └── motion_info
│&nbsp;&nbsp;             └── fd.txt</code></pre>
<p>This is a very structured format, though somewhat complicated. So long as your folder and file structure is systematically organized (e.g., keeping the use of upper and lower case letters the same), this sort of task is easily handled through programming.</p>
<section id="scope-what-datafiles-do-we-need" class="level2">
<h2 class="anchored" data-anchor-id="scope-what-datafiles-do-we-need">Scope: what data/files do we need?</h2>
<p>We want all of these fd.txt files to be read into R so that we can diagnose FD problems for each subject. This means we need to loop over these in some way, read each of them, and compute motion metrics for each subject.</p>
</section>
<section id="scope-what-computations-are-needed" class="level2">
<h2 class="anchored" data-anchor-id="scope-what-computations-are-needed">Scope: what computations are needed?</h2>
<p>Our motion metrics:</p>
<ol type="1">
<li>Average FD (mm) – how much were they typically moving?</li>
<li>Max FD (mm) – what was the worst jump?</li>
<li>Proportion of FD values &gt; 0.3mm – spikes generate problems</li>
</ol>
</section>
</section>
<section id="whats-the-structure-of-the-data" class="level1">
<h1>2. What’s the structure of the data?</h1>
<p>Let’s look at one FD file:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#location of an example file to play with</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>single_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(working_dir, <span class="st">"mot_example"</span>, <span class="st">"MMClock"</span>, <span class="st">"MR_Proc"</span>, <span class="st">"10637_20140304"</span>, </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"mni_aroma_minimal_fsl"</span>, <span class="st">"rest1"</span>, <span class="st">"motion_info"</span>, <span class="st">"fd.txt"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>fd1 <span class="ot">&lt;-</span> <span class="fu">read.table</span>(single_file, <span class="at">col.names =</span> <span class="st">"fd"</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(fd1)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   300 obs. of  1 variable:
 $ fd: num  0 0.1396 0.0919 0.1559 0.1331 ...</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(fd1)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">fd</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.140</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.092</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.156</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.133</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.161</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Here is a quick visual check on what the file contains (head movement over time).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>fd1<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(fd1)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fd1, <span class="fu">aes</span>(<span class="at">x=</span>time, <span class="at">y=</span>fd)) <span class="sc">+</span> <span class="fu">geom_line</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="reproducibility_good_programming_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We really just need <code>$fd</code> for each dataset since it’s one vector (one estimate per timepoint). In future, we probably just need the 300 values as a vector – it doesn’t even merit a data.frame at this stage.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>fdvec <span class="ot">&lt;-</span> fd1<span class="sc">$</span>fd</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="tracking-down-files" class="level2">
<h2 class="anchored" data-anchor-id="tracking-down-files">Tracking down files</h2>
<p>How do we find all of these files? There are many ways, but <code>list.files()</code> is pretty handy:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>fd_root <span class="ot">&lt;-</span> <span class="fu">file.path</span>(working_dir, <span class="st">"mot_example"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>short_path <span class="ot">&lt;-</span> <span class="cf">function</span>(p) <span class="fu">sub</span>(<span class="fu">paste0</span>(fd_root, .Platform<span class="sc">$</span>file.sep), <span class="st">""</span>, p, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>fd_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">path =</span> fd_root,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">pattern =</span> <span class="st">"fd</span><span class="sc">\\</span><span class="st">.txt$"</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">recursive =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">full.names =</span> <span class="cn">TRUE</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">short_path</span>(fd_files))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "MMClock/MR_Proc/10637_20140304/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt"
[2] "MMClock/MR_Proc/10638_20140507/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt"
[3] "MMClock/MR_Proc/10662_20140415/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt"
[4] "MMClock/MR_Proc/10711_20140826/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt"
[5] "MMClock/MR_Proc/10717_20140813/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt"
[6] "MMClock/MR_Proc/10767_20140814/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt"</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(fd_files)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 130</code></pre>
</div>
</div>
</section>
</section>
<section id="articulate-the-desired-outputs-and-define-success" class="level1">
<h1>3. Articulate the desired outputs and define success</h1>
<p>As noted above, we want to get some summary statistics about FD for each subject such as the mean and max.</p>
<p>In terms of the success of this project, we also want to flag anyone who should be excluded from analysis altogether (data beyond repair). This is a conceptual choice in data analysis – how to handle outliers, including data removal or downweighting.</p>
<p>For my purposes, I consider a subject irreparable if:</p>
<ol type="1">
<li>Max FD &gt; 10mm – any huge movement</li>
<li>p(FD &gt; 0.3mm) &gt; 20% – subject is moving regularly throughout the scan</li>
</ol>
<p>Either of these could lead my connectivity estimates to be corrupt and untrustworthy. Hence the reason for exclusion.</p>
<p>The algorithm would be successful if we 1) got the summary statistics of interest, and 2) removed or flagged subjects who are irreparable for either reason above.</p>
</section>
<section id="define-the-importance-of-the-problem-and-the-level-of-your-investment-how-mission-critical-is-this" class="level1">
<h1>4. Define the importance of the problem and the level of your investment: how mission critical is this?</h1>
<p>It’s useful to calibrate your effort on a coding challenge in proportion to its conceptual or methodological importance.</p>
<p>If you’ll never need to do this again, a ‘one-off’ solution may be worthwhile, and you might try to keep your effort on the order of minutes, if possible. If you anticipate needing to do this same operation regularly throughout your career, it may be a time to use functions, comment your code extensively, validate it carefully, and so on.</p>
<p>In the ideal case, functions should be iron clad (resistant to errors) and well-validated. This is why R packages are great – their creators are usually statisticians, methodologists, and/or people who have formal training in computer science. They have usually written their functions to yield very reliable, well-validated input. Thus, when possible, <em>use existing R functions</em> rather than writing custom code. There is a handy package called “sos” that can help you find functions that may be relevant to your case. The example below could be pasted into your R console if you want to try a search for functions having to do with ARIMA models:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">p_load</span>(sos)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">findFn</span>(<span class="st">"arima"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Writing your own functions can be fun, but it can also take considerable time as you’re learning! Likewise, functions that have many steps take longer to write. When possible, try to write compact functions that have very specific actions, rather than writing long functions that have many steps. The larger the function becomes, the greater the possibility that it will need to be adapted when needed on a similar, but not identical, project.</p>
<p>If this problem is absolutely crucial – like you might need to retract paper if it’s wrong – slow down and make sure you check the results in detail for one case/example, as well as the global outputs (e.g., the overall distribution).</p>
<p>Here, keeping high-motion subjects accidentally could easily be seen as a critical flaw in review, or later after publication (slight risk of retraction…), so I want to be careful! Likewise, head motion is a general problem in fMRI data, so since I have many fMRI projects, it would be nice to have friendly code that works well. This will make implementing best practices simple on future projects.</p>
</section>
<section id="prototype-the-process-get-this-working-for-one-test-case." class="level1">
<h1>5. Prototype the process: get this working for one test case.</h1>
<p>So, how do we implement the proposed head motion statistics? Let’s start with one person… We already read in data above, let’s look at it a bit.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(fd1)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 300</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fd1, <span class="fu">aes</span>(<span class="at">x=</span>fd)) <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">bins=</span><span class="dv">12</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="reproducibility_good_programming_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="get-the-mean" class="level2">
<h2 class="anchored" data-anchor-id="get-the-mean">get the mean</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>(mfd <span class="ot">&lt;-</span> <span class="fu">mean</span>(fdvec))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.467</code></pre>
</div>
</div>
</section>
<section id="get-the-max" class="level2">
<h2 class="anchored" data-anchor-id="get-the-max">get the max</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>(maxfd <span class="ot">&lt;-</span> <span class="fu">max</span>(fdvec))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5.42</code></pre>
</div>
</div>
</section>
<section id="how-many-fd-values-are-0.3mm" class="level2">
<h2 class="anchored" data-anchor-id="how-many-fd-values-are-0.3mm">how many FD values are &gt; 0.3mm?</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>(nspikes <span class="ot">&lt;-</span> <span class="fu">sum</span>(fdvec <span class="sc">&gt;</span> fd_spike_mm))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 117</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>(pspikes <span class="ot">&lt;-</span> nspikes<span class="sc">/</span><span class="fu">length</span>(fdvec))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.39</code></pre>
</div>
</div>
</section>
<section id="is-the-subject-irreparable-by-my-criteria" class="level2">
<h2 class="anchored" data-anchor-id="is-the-subject-irreparable-by-my-criteria">Is the subject ‘irreparable’ by my criteria?</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>(bad_subj <span class="ot">&lt;-</span> pspikes <span class="sc">&gt;</span> p_spikes_cutoff <span class="sc">||</span> maxfd <span class="sc">&gt;</span> fd_max_mm)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>This subject is bad on the basis of too many small head movements – 39% are above the threshold I set.</p>
<p>How do we put this together in a single result? A list or data.frame is the easiest.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>(metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">mfd=</span>mfd, <span class="at">maxfd=</span>maxfd, <span class="at">pspikes=</span>pspikes, <span class="at">bad_subj=</span>bad_subj))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">mfd</th>
<th style="text-align: right;">maxfd</th>
<th style="text-align: right;">pspikes</th>
<th style="text-align: left;">bad_subj</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.467</td>
<td style="text-align: right;">5.42</td>
<td style="text-align: right;">0.39</td>
<td style="text-align: left;">TRUE</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
</section>
<section id="validate-the-outputs-of-your-prototype-do-the-programmatic-processes-and-calculations-match-your-hand-checks" class="level1">
<h1>6. Validate the outputs of your prototype: do the programmatic processes and calculations match your hand checks?</h1>
<p>Take a look at the data again:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fd1, <span class="fu">aes</span>(<span class="at">x=</span>time, <span class="at">y=</span>fd, <span class="at">color=</span>fd <span class="sc">&gt;</span> fd_spike_mm)) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color=</span><span class="cn">NULL</span>), <span class="at">color=</span><span class="st">"black"</span>) <span class="sc">+</span> <span class="fu">geom_point</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="reproducibility_good_programming_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fd1, <span class="fu">aes</span>(<span class="at">x=</span><span class="dv">1</span>, <span class="at">fill=</span>fd <span class="sc">&gt;</span> fd_spike_mm)) <span class="sc">+</span> <span class="fu">geom_bar</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="reproducibility_good_programming_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>These are quick, but effective, ways that support the output of the prototype</p>
</section>
<section id="scale-it-up-run-this-process-on-all-examplesiterations" class="level1">
<h1>7. Scale it up: run this process on all examples/iterations</h1>
<p>Here’s the ‘bad’ way to do this even though it is in the right spirit.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>all_fd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (f <span class="cf">in</span> fd_files) {</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  thisperson <span class="ot">&lt;-</span> <span class="fu">read.table</span>(f)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  all_fd <span class="ot">&lt;-</span> <span class="fu">rbind</span>(all_fd, thisperson)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(all_fd)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">V1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.140</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.092</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.156</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.133</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.161</td>
</tr>
</tbody>
</table>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(all_fd)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   39099 obs. of  1 variable:
 $ V1: num  0 0.1396 0.0919 0.1559 0.1331 ...</code></pre>
</div>
</div>
<p>Problems include:</p>
<ol type="1">
<li>No way to identify subjects</li>
<li>We are building up an object by agglomerating one file at a time (lots of memory overhead)</li>
<li>We really shouldn’t start computing motion metrics because we don’t know who is who.</li>
</ol>
<p>Perhaps this approach is a bit better? We could start with an empty <code>data.frame</code> and build up statistics one row at a time.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>all_fd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (f <span class="cf">in</span> fd_files) {</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#read one-column FD file as a numeric vector</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  thisperson <span class="ot">&lt;-</span> <span class="fu">read.table</span>(f, <span class="at">col.names =</span> <span class="st">"fd"</span>)<span class="sc">$</span>fd</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#compute a one-row data.frame for this subject</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  mmetric <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">file=</span><span class="fu">short_path</span>(f), <span class="at">mfd=</span><span class="fu">mean</span>(thisperson), <span class="at">maxfd=</span><span class="fu">max</span>(thisperson), </span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>                        <span class="at">pspikes=</span><span class="fu">sum</span>(thisperson <span class="sc">&gt;</span> fd_spike_mm)<span class="sc">/</span><span class="fu">length</span>(thisperson),</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">bad_subj=</span><span class="fu">max</span>(thisperson) <span class="sc">&gt;</span> fd_max_mm <span class="sc">||</span> </span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">sum</span>(thisperson <span class="sc">&gt;</span> fd_spike_mm)<span class="sc">/</span><span class="fu">length</span>(thisperson) <span class="sc">&gt;</span> p_spikes_cutoff)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add this subject's statistics to the overall data.frame</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  all_fd <span class="ot">&lt;-</span> <span class="fu">rbind</span>(all_fd, mmetric)</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(all_fd)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 72%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 7%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">file</th>
<th style="text-align: right;">mfd</th>
<th style="text-align: right;">maxfd</th>
<th style="text-align: right;">pspikes</th>
<th style="text-align: left;">bad_subj</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">MMClock/MR_Proc/10637_20140304/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt</td>
<td style="text-align: right;">0.467</td>
<td style="text-align: right;">5.416</td>
<td style="text-align: right;">0.390</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="even">
<td style="text-align: left;">MMClock/MR_Proc/10638_20140507/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt</td>
<td style="text-align: right;">0.148</td>
<td style="text-align: right;">1.579</td>
<td style="text-align: right;">0.063</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">MMClock/MR_Proc/10662_20140415/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt</td>
<td style="text-align: right;">0.153</td>
<td style="text-align: right;">0.455</td>
<td style="text-align: right;">0.053</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">MMClock/MR_Proc/10711_20140826/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt</td>
<td style="text-align: right;">0.584</td>
<td style="text-align: right;">4.684</td>
<td style="text-align: right;">0.460</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">MMClock/MR_Proc/10717_20140813/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt</td>
<td style="text-align: right;">0.172</td>
<td style="text-align: right;">2.252</td>
<td style="text-align: right;">0.073</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">MMClock/MR_Proc/10767_20140814/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt</td>
<td style="text-align: right;">0.123</td>
<td style="text-align: right;">1.493</td>
<td style="text-align: right;">0.033</td>
<td style="text-align: left;">FALSE</td>
</tr>
</tbody>
</table>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(all_fd)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   130 obs. of  5 variables:
 $ file    : chr  "MMClock/MR_Proc/10637_20140304/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt" "MMClock/MR_Proc/10638_20140507/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt" "MMClock/MR_Proc/10662_20140415/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt" "MMClock/MR_Proc/10711_20140826/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt" ...
 $ mfd     : num  0.467 0.148 0.153 0.584 0.172 ...
 $ maxfd   : num  5.416 1.579 0.455 4.684 2.252 ...
 $ pspikes : num  0.39 0.0633 0.0533 0.46 0.0733 ...
 $ bad_subj: logi  TRUE FALSE FALSE TRUE FALSE FALSE ...</code></pre>
</div>
</div>
<p>There are a few problems here.</p>
<p>First, building up a large data.frame by repetitively rbinding means that there is a lot of processing time spent on memory management – the <code>all_fd</code> object has to be reallocated on every iteration. We could handle this problem more elegantly using an <code>lapply</code> + <code>dplyr::bind_rows</code> approach. Like so:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>all_fd <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="fu">lapply</span>(fd_files, <span class="cf">function</span>(f) {</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">#read one-column FD file as a numeric vector</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  thisperson <span class="ot">&lt;-</span> <span class="fu">read.table</span>(f, <span class="at">col.names =</span> <span class="st">"fd"</span>)<span class="sc">$</span>fd</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#compute a one-row data.frame for this subject</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  mmetric <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">file=</span><span class="fu">short_path</span>(f), <span class="at">mfd=</span><span class="fu">mean</span>(thisperson), <span class="at">maxfd=</span><span class="fu">max</span>(thisperson), </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">pspikes=</span><span class="fu">sum</span>(thisperson <span class="sc">&gt;</span> fd_spike_mm)<span class="sc">/</span><span class="fu">length</span>(thisperson),</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">bad_subj=</span><span class="fu">max</span>(thisperson) <span class="sc">&gt;</span> fd_max_mm <span class="sc">||</span> </span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">sum</span>(thisperson <span class="sc">&gt;</span> fd_spike_mm)<span class="sc">/</span><span class="fu">length</span>(thisperson) <span class="sc">&gt;</span> p_spikes_cutoff,</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>) <span class="co">#store file as character string to quiet bind_rows</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(all_fd)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 72%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 7%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">file</th>
<th style="text-align: right;">mfd</th>
<th style="text-align: right;">maxfd</th>
<th style="text-align: right;">pspikes</th>
<th style="text-align: left;">bad_subj</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">MMClock/MR_Proc/10637_20140304/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt</td>
<td style="text-align: right;">0.467</td>
<td style="text-align: right;">5.416</td>
<td style="text-align: right;">0.390</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="even">
<td style="text-align: left;">MMClock/MR_Proc/10638_20140507/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt</td>
<td style="text-align: right;">0.148</td>
<td style="text-align: right;">1.579</td>
<td style="text-align: right;">0.063</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">MMClock/MR_Proc/10662_20140415/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt</td>
<td style="text-align: right;">0.153</td>
<td style="text-align: right;">0.455</td>
<td style="text-align: right;">0.053</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">MMClock/MR_Proc/10711_20140826/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt</td>
<td style="text-align: right;">0.584</td>
<td style="text-align: right;">4.684</td>
<td style="text-align: right;">0.460</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">MMClock/MR_Proc/10717_20140813/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt</td>
<td style="text-align: right;">0.172</td>
<td style="text-align: right;">2.252</td>
<td style="text-align: right;">0.073</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">MMClock/MR_Proc/10767_20140814/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt</td>
<td style="text-align: right;">0.123</td>
<td style="text-align: right;">1.493</td>
<td style="text-align: right;">0.033</td>
<td style="text-align: left;">FALSE</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Note that <code>bind_rows</code> from <code>dplyr</code> does a row-wise concatenation of all elements in a list – here, the single-row data.frame objects for each subject.</p>
<p>Second, although we now have a record of subject identity because we’ve tacked on the filename to the resulting <code>data.frame</code>, this is organized in terms of the file path, not by identifying variables such as subject ID or scan date. We could extract the ID more elegantly using regular expressions, though this has its own learning curve:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">#tack on ID column based on file naming</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>all_fd<span class="sc">$</span>ID <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*/MR_Proc/([^/]+)/mni.*"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, all_fd<span class="sc">$</span>file)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(all_fd)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 63%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">file</th>
<th style="text-align: right;">mfd</th>
<th style="text-align: right;">maxfd</th>
<th style="text-align: right;">pspikes</th>
<th style="text-align: left;">bad_subj</th>
<th style="text-align: left;">ID</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">MMClock/MR_Proc/10637_20140304/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt</td>
<td style="text-align: right;">0.467</td>
<td style="text-align: right;">5.416</td>
<td style="text-align: right;">0.390</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">10637_20140304</td>
</tr>
<tr class="even">
<td style="text-align: left;">MMClock/MR_Proc/10638_20140507/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt</td>
<td style="text-align: right;">0.148</td>
<td style="text-align: right;">1.579</td>
<td style="text-align: right;">0.063</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">10638_20140507</td>
</tr>
<tr class="odd">
<td style="text-align: left;">MMClock/MR_Proc/10662_20140415/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt</td>
<td style="text-align: right;">0.153</td>
<td style="text-align: right;">0.455</td>
<td style="text-align: right;">0.053</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">10662_20140415</td>
</tr>
<tr class="even">
<td style="text-align: left;">MMClock/MR_Proc/10711_20140826/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt</td>
<td style="text-align: right;">0.584</td>
<td style="text-align: right;">4.684</td>
<td style="text-align: right;">0.460</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">10711_20140826</td>
</tr>
<tr class="odd">
<td style="text-align: left;">MMClock/MR_Proc/10717_20140813/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt</td>
<td style="text-align: right;">0.172</td>
<td style="text-align: right;">2.252</td>
<td style="text-align: right;">0.073</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">10717_20140813</td>
</tr>
<tr class="even">
<td style="text-align: left;">MMClock/MR_Proc/10767_20140814/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt</td>
<td style="text-align: right;">0.123</td>
<td style="text-align: right;">1.493</td>
<td style="text-align: right;">0.033</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">10767_20140814</td>
</tr>
</tbody>
</table>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">#rearrange columns in a friendly order. Put ID first, then file, then all the rest</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>all_fd <span class="ot">&lt;-</span> all_fd <span class="sc">%&gt;%</span> <span class="fu">select</span>(ID, file, <span class="fu">everything</span>())</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(all_fd)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   130 obs. of  6 variables:
 $ ID      : chr  "10637_20140304" "10638_20140507" "10662_20140415" "10711_20140826" ...
 $ file    : chr  "MMClock/MR_Proc/10637_20140304/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt" "MMClock/MR_Proc/10638_20140507/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt" "MMClock/MR_Proc/10662_20140415/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt" "MMClock/MR_Proc/10711_20140826/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt" ...
 $ mfd     : num  0.467 0.148 0.153 0.584 0.172 ...
 $ maxfd   : num  5.416 1.579 0.455 4.684 2.252 ...
 $ pspikes : num  0.39 0.0633 0.0533 0.46 0.0733 ...
 $ bad_subj: logi  TRUE FALSE FALSE TRUE FALSE FALSE ...</code></pre>
</div>
</div>
<p>Third, this approach assumes that all FD files are relevant to the task at hand. However, keep step 9 in mind: validate the global outputs. If we are interested in checking the motion statistics on the whole sample and also want to know who should be included or excluded from analysis, the approach of reading all files may mislead us. For example, if we wish to report group statistics such as mean FD in the paper, we need to ensure that all files are in the set of subjects to be analyzed.</p>
<section id="using-the-participant-info-to-guide-us" class="level2">
<h2 class="anchored" data-anchor-id="using-the-participant-info-to-guide-us">Using the participant info to guide us</h2>
<p>That is, one problem with looping over files is that we may catch subjects we don’t want (for other exclusion criteria) or we may be missing a file for someone whose data we expect to be present. For this reason, it’s usually best in these kinds of batch operations to have a basic records file that keeps track of expected participants. Furthermore, this file should include information about any other exclusion criteria that should be accounted for at this step. For example, we may exclude someone after the fMRI scan if they fell asleep during the experimental task, or if their performance was remarkably poor.</p>
<p>Here, let’s read in a participant info file to guide us on whose <code>fd.txt</code> files are relevant to our group analysis. Note the <code>FMRI_Exclude</code> column. Furthermore, this is a study where the data were collected in two parallel substudies, which are organized into different top-level folders: <code>MMClock</code> and <code>SPECC</code>. So, we need to do a bit of dplyr-based data wrangling to get the expected structure setup.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>groupdir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(working_dir, <span class="st">"mot_example"</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>mr_subdir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"mni_aroma_minimal_fsl"</span>, <span class="st">"rest1"</span>) <span class="co">#this is where we expect the processed fMRI data for each subject</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>expect_mr_file <span class="ot">&lt;-</span> <span class="st">"rnawuktm_rest1.nii.gz"</span> <span class="co">#this is the expected file name of the fMRI data</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co">#read in and process data</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>specc_info <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">file.path</span>(<span class="st">".."</span>, <span class="st">"files"</span>, <span class="st">"SPECC_Participant_Info.csv"</span>), <span class="at">stringsAsFactors=</span><span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(HasRest<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> FMRI_Exclude<span class="sc">==</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ScanDate =</span> <span class="fu">as.Date</span>(ScanDate, <span class="at">format=</span><span class="st">"%m/%d/%y"</span>), <span class="at">Luna_ID=</span><span class="fu">as.character</span>(Luna_ID)) <span class="sc">%&gt;%</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#If LunaMRI is 1, then data are in the MMClock substudy</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  Convert ScanDate Date, then reformat YYYYMMDD to match the folder naming structure of MMClock</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">#If LunaMRI is 0, use the SPECC folder and reformat data as DDMONYR to match folder naming structure.</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mr_dir=</span><span class="fu">if_else</span>(LunaMRI<span class="sc">==</span><span class="dv">1</span>,</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">file.path</span>(groupdir, <span class="st">"MMClock"</span>, <span class="st">"MR_Proc"</span>,</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">paste0</span>(Luna_ID, <span class="st">"_"</span>, <span class="fu">format</span>((<span class="fu">as.Date</span>(ScanDate, <span class="at">format=</span><span class="st">"%Y-%m-%d"</span>)), <span class="st">"%Y%m%d"</span>))),</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">file.path</span>(groupdir, <span class="st">"SPECC"</span>, <span class="st">"MR_Proc"</span>,</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">paste0</span>(<span class="fu">tolower</span>(SPECC_ID), <span class="st">"_"</span>, <span class="fu">tolower</span>(<span class="fu">format</span>((<span class="fu">as.Date</span>(ScanDate, <span class="at">format=</span><span class="st">"%Y-%m-%d"</span>)), <span class="st">"%d%b%Y"</span>))))),</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">mr_file=</span><span class="fu">file.path</span>(mr_dir, mr_subdir, expect_mr_file), </span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">fd_file=</span><span class="fu">file.path</span>(mr_dir, mr_subdir, <span class="st">"motion_info"</span>, <span class="st">"fd.txt"</span>), </span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">mr_exists=</span><span class="fu">file.exists</span>(mr_file), </span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">file_id=</span><span class="fu">if_else</span>(LunaMRI<span class="sc">==</span><span class="dv">1</span>, Luna_ID, SPECC_ID))</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(specc_info)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   90 obs. of  17 variables:
 $ NUM_ID         : int  1 2 3 5 8 10 12 13 15 16 ...
 $ SPECC_ID       : chr  "001RA" "002HS" "003BU" "005AI" ...
 $ Luna_ID        : chr  "11131" "10997" "10895" "10644" ...
 $ BPD            : int  0 0 0 0 1 0 0 1 1 0 ...
 $ ScanDate       : Date, format: "2013-12-07" "2014-03-08" ...
 $ AgeAtScan      : num  20.5 16.2 21.6 15.2 22.8 ...
 $ Female         : int  0 1 1 1 1 1 1 1 1 0 ...
 $ HasRest        : int  1 1 1 1 1 1 1 1 1 1 ...
 $ LunaMRI        : int  0 1 1 0 0 1 1 0 0 1 ...
 $ HasClock       : int  1 1 1 1 1 1 1 1 1 1 ...
 $ FMRI_Exclude   : int  0 0 0 0 0 0 0 0 0 0 ...
 $ Wrong_fmap_dims: int  1 1 1 1 1 1 1 0 0 0 ...
 $ mr_dir         : chr  "./.render-tmp/reproducibility_good_programming/mot_example/SPECC/MR_Proc/001ra_07dec2013" "./.render-tmp/reproducibility_good_programming/mot_example/MMClock/MR_Proc/10997_20140308" "./.render-tmp/reproducibility_good_programming/mot_example/MMClock/MR_Proc/10895_20131204" "./.render-tmp/reproducibility_good_programming/mot_example/SPECC/MR_Proc/005ai_06nov2013" ...
 $ mr_file        : chr  "./.render-tmp/reproducibility_good_programming/mot_example/SPECC/MR_Proc/001ra_07dec2013/mni_aroma_minimal_fsl/"| __truncated__ "./.render-tmp/reproducibility_good_programming/mot_example/MMClock/MR_Proc/10997_20140308/mni_aroma_minimal_fsl"| __truncated__ "./.render-tmp/reproducibility_good_programming/mot_example/MMClock/MR_Proc/10895_20131204/mni_aroma_minimal_fsl"| __truncated__ "./.render-tmp/reproducibility_good_programming/mot_example/SPECC/MR_Proc/005ai_06nov2013/mni_aroma_minimal_fsl/"| __truncated__ ...
 $ fd_file        : chr  "./.render-tmp/reproducibility_good_programming/mot_example/SPECC/MR_Proc/001ra_07dec2013/mni_aroma_minimal_fsl/"| __truncated__ "./.render-tmp/reproducibility_good_programming/mot_example/MMClock/MR_Proc/10997_20140308/mni_aroma_minimal_fsl"| __truncated__ "./.render-tmp/reproducibility_good_programming/mot_example/MMClock/MR_Proc/10895_20131204/mni_aroma_minimal_fsl"| __truncated__ "./.render-tmp/reproducibility_good_programming/mot_example/SPECC/MR_Proc/005ai_06nov2013/mni_aroma_minimal_fsl/"| __truncated__ ...
 $ mr_exists      : logi  FALSE FALSE FALSE FALSE FALSE FALSE ...
 $ file_id        : chr  "001RA" "10997" "10895" "005AI" ...</code></pre>
</div>
</div>
<p>Here are the first 10 expected FD files based on the subject information file:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">#just using sub here to trim off the working_dir from fd file paths to make it easier to see in the output</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">sub</span>(working_dir, <span class="st">""</span>, specc_info<span class="sc">$</span>fd_file, <span class="at">fixed=</span><span class="cn">TRUE</span>), <span class="at">n=</span><span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "/mot_example/SPECC/MR_Proc/001ra_07dec2013/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt" 
 [2] "/mot_example/MMClock/MR_Proc/10997_20140308/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt"
 [3] "/mot_example/MMClock/MR_Proc/10895_20131204/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt"
 [4] "/mot_example/SPECC/MR_Proc/005ai_06nov2013/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt" 
 [5] "/mot_example/SPECC/MR_Proc/008jh_13jan2014/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt" 
 [6] "/mot_example/MMClock/MR_Proc/11250_20140228/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt"
 [7] "/mot_example/MMClock/MR_Proc/11252_20140213/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt"
 [8] "/mot_example/SPECC/MR_Proc/013jk_30apr2014/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt" 
 [9] "/mot_example/SPECC/MR_Proc/015cw_03may2014/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt" 
[10] "/mot_example/MMClock/MR_Proc/11277_20140410/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt"</code></pre>
</div>
</div>
<p>Note that I trimmed off the first part of the path to make it easier to see on the screen.</p>
</section>
<section id="writing-a-worker-function" class="level2">
<h2 class="anchored" data-anchor-id="writing-a-worker-function">Writing a worker function</h2>
<p>Now that we have the FD files we expect to read from relevant subjects, it would be useful to write a short function to compute relevant FD statistics. This essentially does what we were doing in the loop above, but lets us have a predictable piece of code that takes a file, the relevant decision thresholds (e.g., how much movement is ‘too much’) and gives predictable outputs.</p>
<p>Importantly, as we will see in step 8 (self-healing code), functions also give us much finer control over how to handle unexpected or missing inputs (e.g., FD files that don’t match the typical format).</p>
<p>Let’s write a very simple function, then test it on our example file. This essentially goes back to step 6 for a moment (develop a working prototype), but with the goal of having a portable function that will help with scaling.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">#simplest worker function to get statistics for one file</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co">#note that the default arguments here may not match the thresholds in the overall pipeline</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>fd_stats_naive <span class="ot">&lt;-</span> <span class="cf">function</span>(fd_file, <span class="at">fd_spike=</span><span class="fl">0.5</span>, <span class="at">max_prop_spikes=</span>.<span class="dv">1</span>, <span class="at">max_spike=</span><span class="dv">5</span>) {</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  fd <span class="ot">&lt;-</span> <span class="fu">read.table</span>(fd_file, <span class="at">col.names =</span> <span class="st">"fd"</span>)<span class="sc">$</span>fd <span class="co">#vector of FD values</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  n_spikes<span class="ot">=</span><span class="fu">sum</span>(fd <span class="sc">&gt;</span> fd_spike) <span class="co">#number of spikes above the threshold</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  p_spikes <span class="ot">&lt;-</span> n_spikes<span class="sc">/</span><span class="fu">length</span>(fd) <span class="co">#spikes as a proportion of total volumes</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  bad_fd <span class="ot">&lt;-</span> p_spikes <span class="sc">&gt;</span> max_prop_spikes <span class="sc">||</span> <span class="fu">any</span>(fd <span class="sc">&gt;</span> max_spike) <span class="co">#decisions above subject exclusion</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">mean_fd=</span><span class="fu">mean</span>(fd), <span class="at">max_fd=</span><span class="fu">max</span>(fd), <span class="at">nvol=</span><span class="fu">length</span>(fd),</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">prop_spikes=</span>p_spikes, <span class="at">bad_fd=</span>bad_fd) <span class="co">#note that map_dfr from purrr (below) would accept a list, too</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ret)</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Okay, here’s the output of our function for the test file:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">#test this on a single case</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">fd_stats_naive</span>(single_file)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">mean_fd</th>
<th style="text-align: right;">max_fd</th>
<th style="text-align: right;">nvol</th>
<th style="text-align: right;">prop_spikes</th>
<th style="text-align: left;">bad_fd</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.467</td>
<td style="text-align: right;">5.42</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">0.23</td>
<td style="text-align: left;">TRUE</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Ack! Why doesn’t this match our hand calculations above for spike proportion? Note that in the function call above, we only provided <code>single_file</code> as the argument to <code>fd_stats_naive</code>. But the default arguments for the function are:</p>
<p><code>fd_stats_naive &lt;- function(fd_file, fd_spike=0.5, max_prop_spikes=.1, max_spike=5) {</code></p>
<p>Thus, the default is to treat FD &gt; 0.5mm as a spike, whereas we chose 0.3. There are similar mismatches between the defaults for max FD and proportion of spikes. This highlights that it is important to know the default arguments, if any, for a function. And if we should always require the user to specify every input to a function explicitly, it may be better not to use default arguments at all.</p>
<p>Here’s how we correct this small oversight here. We pass forward the thresholds set at the top of this document so that the decisions/calculations match our choices above.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fd_stats_naive</span>(single_file, <span class="at">fd_spike =</span> fd_spike_mm, <span class="at">max_prop_spikes =</span> p_spikes_cutoff, <span class="at">max_spike=</span>fd_max_mm)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">mean_fd</th>
<th style="text-align: right;">max_fd</th>
<th style="text-align: right;">nvol</th>
<th style="text-align: right;">prop_spikes</th>
<th style="text-align: left;">bad_fd</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.467</td>
<td style="text-align: right;">5.42</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">0.39</td>
<td style="text-align: left;">TRUE</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Now that we have a working prototype, let’s write a more robust worker function that we will use throughout the rest of this pipeline. In particular, it will handle missing FD files gracefully by returning NAs (with a warning) rather than crashing.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">#worker function to get statistics for one file (robust to missing files)</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>fd_stats <span class="ot">&lt;-</span> <span class="cf">function</span>(fd_file, <span class="at">fd_spike=</span><span class="fl">0.5</span>, <span class="at">max_prop_spikes=</span>.<span class="dv">1</span>, <span class="at">max_spike=</span><span class="dv">5</span>) {</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(fd_file)) {</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"Could not read FD file: "</span>, fd_file, <span class="st">". Returning NAs."</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">mean_fd=</span><span class="cn">NA</span>, <span class="at">max_fd=</span><span class="cn">NA</span>, <span class="at">nvol=</span><span class="cn">NA</span>, <span class="at">prop_spikes=</span><span class="cn">NA</span>, <span class="at">bad_fd=</span><span class="cn">NA</span>))</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  fd <span class="ot">&lt;-</span> <span class="fu">read.table</span>(fd_file, <span class="at">col.names =</span> <span class="st">"fd"</span>)<span class="sc">$</span>fd <span class="co">#vector of FDs</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  n_spikes<span class="ot">=</span><span class="fu">sum</span>(fd <span class="sc">&gt;</span> fd_spike)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  p_spikes <span class="ot">&lt;-</span> n_spikes<span class="sc">/</span><span class="fu">length</span>(fd)</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  bad_fd <span class="ot">&lt;-</span> p_spikes <span class="sc">&gt;</span> max_prop_spikes <span class="sc">||</span> <span class="fu">any</span>(fd <span class="sc">&gt;</span> max_spike)</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">mean_fd=</span><span class="fu">mean</span>(fd), <span class="at">max_fd=</span><span class="fu">max</span>(fd), <span class="at">nvol=</span><span class="fu">length</span>(fd),</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>                    <span class="at">prop_spikes=</span>p_spikes, <span class="at">bad_fd=</span>bad_fd)</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ret)</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Finally, we can use the <code>map</code> functions from the <code>purrr</code> package to scale up this sort of calculation rather easily. In particular, look at the <code>map_dfr</code> function, which maps over a vector/list and then row-binds (like <code>dplyr::bind_rows</code>) the returned data frames/tibbles. Here, we map over <code>.$fd_file</code> (a vector of file paths), compute one-row motion summaries for each file, and bind them into one data.frame.</p>
<p>Remember that <code>.</code> in a <code>dplyr</code> pipeline refers to the current dataset.</p>
<p>Let’s add motion information as additional columns to our participant info data.frame using <code>purrr::map_dfr</code> approach</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>specc_info <span class="ot">&lt;-</span> specc_info <span class="sc">%&gt;%</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">map_dfr</span>(.<span class="sc">$</span>fd_file, fd_stats, <span class="at">fd_spike=</span>fd_spike_mm, <span class="at">max_prop_spikes=</span>p_spikes_cutoff, <span class="at">max_spike=</span>fd_max_mm))</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co">#If you wanted the group fd data.frame alone</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co">#vv &lt;- map_dfr(specc_info$fd_file, fd_stats, fd_spike=0.5, max_prop_spikes=.20, max_spike=fd_max_mm)</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co">#just print the motion-relevant parts</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(specc_info <span class="sc">%&gt;%</span> <span class="fu">select</span>(NUM_ID, mean_fd, max_fd, nvol, prop_spikes, bad_fd))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">NUM_ID</th>
<th style="text-align: right;">mean_fd</th>
<th style="text-align: right;">max_fd</th>
<th style="text-align: right;">nvol</th>
<th style="text-align: right;">prop_spikes</th>
<th style="text-align: left;">bad_fd</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.192</td>
<td style="text-align: right;">0.535</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">0.187</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">0.085</td>
<td style="text-align: right;">0.266</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">0.127</td>
<td style="text-align: right;">0.284</td>
<td style="text-align: right;">350</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">0.133</td>
<td style="text-align: right;">0.378</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">0.007</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">8</td>
<td style="text-align: right;">0.166</td>
<td style="text-align: right;">1.063</td>
<td style="text-align: right;">350</td>
<td style="text-align: right;">0.069</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: right;">0.218</td>
<td style="text-align: right;">5.772</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">0.087</td>
<td style="text-align: left;">FALSE</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
</section>
<section id="make-the-process-self-healing-expect-problems-and-handle-failures-gracefully" class="level1">
<h1>8. Make the process self-healing: expect problems and handle failures gracefully</h1>
<p>This is great, but what if the function encounters problems with the file that it cannot handle effectively? For example, what if the file does not exist? Or what if it has many columns instead of one? Or what if we expect there to be 300 volumes, but only 200 are found?</p>
<p>All of these failure conditions may require a different treatment. But minimally, we (the user) want to know about them. If you write a function, start by validating the inputs. If one argument is a file, does it exist? Is an argument missing and no default value makes sense? Check out <code>warning</code> and <code>message</code> to provide feedback to the user of your function (which is probably you!) for messages that do not stop the execution of the code (i.e., they won’t crash). Check out <code>stopifnot</code> and <code>stop</code> to throw errors if the function shouldn’t proceed at all until the user fixes the problem.</p>
<p>Let’s examine the case of a file that is expected to be present, but is not. I’ve messed up the file structure a bit here, and we’ll try to compute motion stats using our naive function.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">#using the naive function here will crash when it hits the missing file</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>vv <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(specc_info<span class="sc">$</span>fd_file, fd_stats_naive, <span class="at">fd_spike=</span>fd_spike_mm, <span class="at">max_prop_spikes=</span>p_spikes_cutoff, <span class="at">max_spike=</span>fd_max_mm)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in file(file, "rt"): cannot open file
'./.render-tmp/reproducibility_good_programming/mot_example/MMClock/MR_Proc/11366_20150425/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt':
No such file or directory</code></pre>
</div>
<div class="cell-output cell-output-error">
<pre><code>Error in `map()`:
ℹ In index: 87.
Caused by error in `file()`:
! cannot open the connection</code></pre>
</div>
</div>
<p>In this case, R gives us a reasonably sane, somewhat intuitive error message. In other cases, you may get very odd errors that don’t make much sense at first glance. Regardless, validating the inputs to your function can cut down on unexpected, strange errors.</p>
<section id="defining-expected-inputs-and-what-to-do-about-failures" class="level2">
<h2 class="anchored" data-anchor-id="defining-expected-inputs-and-what-to-do-about-failures">Defining expected inputs and what to do about failures</h2>
<p>Part of making code self-healing is to ask yourself:</p>
<ol type="1">
<li>What does the code need to do its work? (i.e., what are the inputs?)</li>
<li>What should the code do if an input is not what is expected?</li>
<li>Should an unexpected condition stop the overall execution of a pipeline, or be handled gracefully with a warning?</li>
</ol>
<p>The third question is not a leading one. Rather, there are occasions when an entire pipeline should fail if one input is wrong because proceeding would invalidate other steps in the pipeline or give misleading results. In other cases, the failure of one step or iteration in a pipeline should not halt the broader process.</p>
<p>Here, if an FD file does not exist for a subject, I would lean toward telling the user about it, but not halting the broader pipeline. To make that work, the function should:</p>
<ol type="1">
<li>Check whether the file exists.</li>
<li>If it doesn’t, tell the user about the problem.</li>
<li>Return NA values for motion metrics so that the function behaves predictably.</li>
</ol>
<p>With respect to the third item, one principle of functional programming is that the output structure should always be the same so that the user of a function knows what to expect. If we are supposed to return a one-row data.frame with motion metrics, we should still do so in the case of handling problems with warnings – that is non-fatal failure conditions. If the function does not behave predictably in its outputs (e.g., returning NULL instead of a data.frame), then it will be prone to failures in a broader pipeline.</p>
<p>Our pipeline uses <code>fd_stats()</code>, which checks that the file exists and returns a predictable one-row data.frame of NAs (with a warning) if it does not.</p>
<p>Here is how it handles the case of the missing file in the context of the broader pipeline:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>vv <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(specc_info<span class="sc">$</span>fd_file, fd_stats, <span class="at">fd_spike=</span>fd_spike_mm, <span class="at">max_prop_spikes=</span>p_spikes_cutoff, <span class="at">max_spike=</span>fd_max_mm)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in .f(.x[[i]], ...): Could not read FD file:
./.render-tmp/reproducibility_good_programming/mot_example/MMClock/MR_Proc/11366_20150425/mni_aroma_minimal_fsl/rest1/motion_info/fd.txt.
Returning NAs.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(vv)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   mean_fd max_fd nvol prop_spikes bad_fd
1   0.1924  0.535  300     0.18667  FALSE
2   0.0848  0.266  300     0.00000  FALSE
3   0.1273  0.284  350     0.00000  FALSE
4   0.1331  0.378  300     0.00667  FALSE
5   0.1664  1.063  350     0.06857  FALSE
6   0.2179  5.772  300     0.08667  FALSE
7   0.0867  0.566  300     0.01000  FALSE
8   0.2505  1.748  300     0.26333   TRUE
9   0.1741  1.196  300     0.08667  FALSE
10  0.1799  0.669  300     0.15333  FALSE
11  0.0899  0.234  300     0.00000  FALSE
12  0.1364  0.721  300     0.04000  FALSE
13  0.2135  1.622  300     0.15333  FALSE
14  0.2187  2.160  300     0.14000  FALSE
15  0.0996  0.235  300     0.00000  FALSE
16  0.1294  0.446  300     0.02000  FALSE
17  0.1191  0.421  300     0.01333  FALSE
18  0.1699  2.590  300     0.12667  FALSE
19  0.1507  0.421  300     0.05000  FALSE
20  0.4055  9.938  300     0.14667  FALSE
21  0.2418  2.720  300     0.13000  FALSE
22  0.1995  1.375  300     0.14000  FALSE
23  0.1174  0.838  300     0.03333  FALSE
24  0.1488  0.379  300     0.00333  FALSE
25  0.1584  0.790  300     0.06333  FALSE
26  0.1527  0.832  300     0.04000  FALSE
27  0.2976  1.416  300     0.36333   TRUE
28  0.6360 13.915  300     0.45333   TRUE
29  0.1090  0.528  300     0.02000  FALSE
30  0.4719  6.919  300     0.34333   TRUE
31  0.1642  1.023  300     0.08667  FALSE
32  0.1029  0.778  300     0.01667  FALSE
33  0.1256  0.344  300     0.01667  FALSE
34  0.1710  2.364  300     0.08667  FALSE
35  0.1414  0.299  300     0.00000  FALSE
36  0.1018  0.309  300     0.00333  FALSE
37  0.1735  1.984  300     0.06000  FALSE
38  0.1524  2.227  300     0.04667  FALSE
39  0.5838  4.684  300     0.46000   TRUE
40  0.2280  0.662  300     0.25333   TRUE
41  0.1135  0.728  300     0.01333  FALSE
42  0.1472  0.352  300     0.01667  FALSE
43  0.3695  3.708  300     0.30333   TRUE
44  0.0830  0.196  300     0.00000  FALSE
45  0.1189  1.743  300     0.03000  FALSE
46  0.1965  0.779  300     0.14667  FALSE
47  0.1149  0.610  300     0.02000  FALSE
48  0.1016  0.694  300     0.08000  FALSE
49  0.4840  8.800  300     0.37000   TRUE
50  0.1966  0.601  300     0.17333  FALSE
51  0.1437  3.184  300     0.01667  FALSE
52  0.1502  1.659  300     0.06333  FALSE
53  0.1525  0.455  300     0.05333  FALSE
54  0.1651  0.747  300     0.10667  FALSE
55  0.2939  2.436  300     0.31000   TRUE
56  0.1113  0.337  300     0.00667  FALSE
57  0.1213  0.476  300     0.01000  FALSE
58  0.4562  3.814  300     0.48000   TRUE
59  0.3325  1.184  300     0.50333   TRUE
60  0.1679  2.180  300     0.08667  FALSE
61  0.2845  4.832  300     0.26000   TRUE
62  0.1039  0.295  300     0.00000  FALSE
63  0.2015  2.564  300     0.13333  FALSE
64  0.1641  1.412  300     0.15667  FALSE
65  0.3127  3.622  300     0.29333   TRUE
66  0.2677  1.663  300     0.40333   TRUE
67  0.0910  0.317  300     0.00333  FALSE
68  0.2199  1.613  300     0.22667   TRUE
69  0.2918  1.039  300     0.44333   TRUE
70  0.1595  0.546  300     0.04000  FALSE
71  0.2050  0.548  300     0.17667  FALSE
72  0.1584  0.708  300     0.10333  FALSE
73  0.1136  0.294  300     0.00000  FALSE
74  0.2304  1.232  300     0.22333   TRUE
75  0.0949  0.975  300     0.00667  FALSE
76  1.1024 19.032  300     0.71667   TRUE
77  0.1420  0.354  300     0.01000  FALSE
78  0.1040  0.485  300     0.02333  FALSE
79  0.0889  0.266  300     0.00000  FALSE
80  0.3496  2.738  300     0.36000   TRUE
81  0.1748  0.484  300     0.10000  FALSE
82  0.1298  0.969  300     0.05667  FALSE
83  0.1448  0.332  300     0.01333  FALSE
84  0.1013  0.193  300     0.00000  FALSE
85  0.2062  1.278  300     0.17000  FALSE
86  0.1510  0.527  300     0.04333  FALSE
87      NA     NA   NA          NA     NA
88  0.1549  1.970  300     0.02667  FALSE
89  0.1241  0.709  300     0.02000  FALSE
90  0.1371  0.520  300     0.02333  FALSE</code></pre>
</div>
</div>
<p>Note the NAs on row 87. This is what we expect (and want) – a graceful failure, with NAs propagated for that subject.</p>
</section>
<section id="more-flexible-error-trapping-using-trycatch" class="level2">
<h2 class="anchored" data-anchor-id="more-flexible-error-trapping-using-trycatch">More flexible error trapping using tryCatch</h2>
<p>For more general error handling in R, particularly in functions, check out the <code>tryCatch</code> function. This function tries to evaluate a given R expression, but allows you to catch and handle any arbitrary error. For example, let’s try to evaluate whether <code>yy</code> is greater than 2. But <code>yy</code> is not defined anywhere in this document – that is, it doesn’t exist. If you just try <code>yy &gt; 2</code>, you will get a fatal error. What if in this circumstance (undefined variable), we instead want to print the error, but return <code>NA</code>?</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">#this will generate an error if uncommented because yy is not defined anywhere in this document</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="co">#is_yy_big &lt;- yy &gt; 2</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>is_yy_big <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(yy <span class="sc">&gt;</span> <span class="dv">2</span>, <span class="at">error=</span><span class="cf">function</span>(err) { <span class="fu">print</span>(err); <span class="fu">return</span>(<span class="cn">NA</span> )})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;simpleError in eval(expr, envir): object 'yy' not found&gt;</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(is_yy_big)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] NA</code></pre>
</div>
</div>
<p>Now that we’re done with the section on handling failures gracefully, I’m going to put the missing fd.txt file back into place for the final step of global metrics.</p>
</section>
</section>
<section id="validate-the-global-outputs-how-will-you-know-that-the-overall-process-has-succeeded" class="level1">
<h1>9. Validate the global outputs: how will you know that the overall process has succeeded?</h1>
<p>Finally, now that our pipeline works, we should step out to the overall sample/global level. From step 3 above (defining success), we said that our pipeline should:</p>
<ol type="1">
<li>generate motion statistics in the form of max and mean FD, as well as proportion of spikes</li>
<li>identify good versus bad subjects according to rational FD exclusion criteria.</li>
</ol>
<p>So, did we achieve this goal? Here is the mean FD for those included versus excluded.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>specc_info <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(bad_fd) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">group_mean=</span><span class="fu">mean</span>(mean_fd, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">bad_fd</th>
<th style="text-align: right;">group_mean</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">0.147</td>
</tr>
<tr class="even">
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">0.393</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Here is the number of people excluded versus included based on FD:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(specc_info<span class="sc">$</span>bad_fd)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
FALSE  TRUE 
   71    19 </code></pre>
</div>
</div>
<p>Here is the histogram of mean FD, colored by inclusion:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>specc_info <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>mean_fd, <span class="at">fill=</span>bad_fd)) <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">bins=</span><span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Histogram of mean FD by exclusion/inclusion"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="reproducibility_good_programming_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>And the histogram for max FD</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>specc_info <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>max_fd, <span class="at">fill=</span>bad_fd)) <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">bins=</span><span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Histogram of max FD by exclusion/inclusion"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="reproducibility_good_programming_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Finally, filter down to the good data:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>specc_info <span class="ot">&lt;-</span> specc_info <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>bad_fd)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>This would yield a data.frame for further analysis.</p>
</section>
<section id="review-the-pipeline-document-key-decisions-and-consider-refactoring-steps-based-on-what-youve-learned" class="level1">
<h1>10. Review the pipeline, document key decisions, and consider refactoring steps based on what you’ve learned</h1>
<section id="code-readability" class="level2">
<h2 class="anchored" data-anchor-id="code-readability">Code readability</h2>
<p>At the end of solving a difficult data analysis challenge, you may have a set of scripts that work, but that are hard to understand. The scripts may have poor code readability (interesting read here: <a href="https://medium.com/@egonelbre/psychology-of-code-readability-d23b1ff1258a" class="uri">https://medium.com/@egonelbre/psychology-of-code-readability-d23b1ff1258a</a>). Common examples include</p>
<ol type="1">
<li>Unclear variable names: <code>tmpa</code> or <code>var22</code>.</li>
<li>Use of numerical indices for subsetting data without documenting the choice: <code>trials_a &lt;- my_matrix[1:50,]</code></li>
<li>Lots of vestigial code that appears similar, but has been commented out:</li>
</ol>
<pre><code>#abc &lt;- read.table("dataset.txt.gz")
#abc &lt;- read.table("dataset_updated.txt.gz")
abc &lt;- read.table("dataset_updated_again.txt.gz")

#abc$trial &lt;- abc$trial - 1
abc$trial &lt;- 1:50</code></pre>
<ol start="4" type="1">
<li>Too much inline code in a large pipeline – abstract to functions!!</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(IDs_list)) {</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(i)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  id <span class="ot">=</span> <span class="fu">as.character</span>(IDs_list[[i]])</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  runVolumeInfo <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(diminfo, ID <span class="sc">==</span> id)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  forRunVolume <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>  forRunVolume <span class="ot">&lt;-</span> <span class="fu">c</span>(forRunVolume, <span class="fu">as.numeric</span>(runVolumeInfo<span class="sc">$</span>runVolumes))</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(forRunVolume) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Hidden dependencies: dozens of objects referenced in this block are assumed to exist.</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>    events <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">event =</span> <span class="st">"partnerchoice"</span>,</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">run =</span> <span class="dv">1</span>,</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">trial =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">144</span>,</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">onset =</span> pchoice_onsets_df[[i]]<span class="sc">/</span><span class="dv">1000</span> <span class="sc">-</span> itifixactions_list[[i]]<span class="sc">/</span><span class="dv">1000</span>,</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">duration =</span> pchoice_durations_df[[i]]<span class="sc">/</span><span class="dv">1000</span></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... plus displaychoice and outcome events ...</span></span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>    trusteeDummyCodes <span class="ot">=</span> trusteeIDs_df[[i]]</span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>    d1 <span class="ot">=</span> dplyr<span class="sc">::</span><span class="fu">recode</span>(trusteeDummyCodes, <span class="st">`</span><span class="at">0</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>, <span class="st">`</span><span class="at">1</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>, <span class="st">`</span><span class="at">-1</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">1</span>)</span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>    d2 <span class="ot">=</span> dplyr<span class="sc">::</span><span class="fu">recode</span>(trusteeDummyCodes, <span class="st">`</span><span class="at">0</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>, <span class="st">`</span><span class="at">1</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">`</span><span class="at">-1</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>)</span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a>    d1xPE <span class="ot">=</span> d1<span class="sc">*</span>modelPEs_tshift_zscore_df[[i]]</span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a>    d2xPE <span class="ot">=</span> d2<span class="sc">*</span>modelPEs_tshift_zscore_df[[i]]</span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>    signals <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">partnerchoice =</span> <span class="fu">list</span>(<span class="at">event =</span> <span class="st">"partnerchoice"</span>, <span class="at">normalization =</span> <span class="st">"none"</span>, <span class="at">value =</span> <span class="fu">data.frame</span>(<span class="at">run =</span> <span class="dv">1</span>, <span class="at">trial =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">144</span>, <span class="at">value =</span> <span class="dv">1</span>)),</span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">outcome =</span> <span class="fu">list</span>(<span class="at">event =</span> <span class="st">"outcome"</span>, <span class="at">normalization =</span> <span class="st">"none"</span>, <span class="at">value =</span> <span class="fu">data.frame</span>(<span class="at">run =</span> <span class="dv">1</span>, <span class="at">trial =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">144</span>, <span class="at">value =</span> <span class="dv">1</span>)),</span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true" tabindex="-1"></a>      <span class="co"># ... dozens more regressors ...</span></span>
<span id="cb67-31"><a href="#cb67-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb67-32"><a href="#cb67-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-33"><a href="#cb67-33" aria-hidden="true" tabindex="-1"></a>    newsubdir <span class="ot">&lt;-</span> id</span>
<span id="cb67-34"><a href="#cb67-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-35"><a href="#cb67-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Side effects: creates directories, changes working directory, and may write files.</span></span>
<span id="cb67-36"><a href="#cb67-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(<span class="fu">file.path</span>(savedmlocation, newsubdir))</span>
<span id="cb67-37"><a href="#cb67-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(<span class="fu">file.path</span>(savedmlocation, newsubdir, <span class="st">"block_design"</span>))</span>
<span id="cb67-38"><a href="#cb67-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setwd</span>(<span class="fu">file.path</span>(savedmlocation, newsubdir, <span class="st">"block_design"</span>))</span>
<span id="cb67-39"><a href="#cb67-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-40"><a href="#cb67-40" aria-hidden="true" tabindex="-1"></a>    simp_tmp_dm <span class="ot">&lt;-</span> <span class="fu">build_design_matrix</span>(<span class="at">events =</span> events, <span class="at">signals =</span> signals, <span class="at">tr=</span> .<span class="dv">6</span>)</span>
<span id="cb67-41"><a href="#cb67-41" aria-hidden="true" tabindex="-1"></a>    simp_dm<span class="ot">&lt;-</span> <span class="fu">rbind</span>(simp_dm, simp_tmp_dm)</span>
<span id="cb67-42"><a href="#cb67-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-43"><a href="#cb67-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... repeat similar blocks:</span></span>
<span id="cb67-44"><a href="#cb67-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - simp_w_interaction</span></span>
<span id="cb67-45"><a href="#cb67-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - parametric_reg</span></span>
<span id="cb67-46"><a href="#cb67-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - parametric_w_interaction</span></span>
<span id="cb67-47"><a href="#cb67-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb67-48"><a href="#cb67-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-49"><a href="#cb67-49" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Key readability problems illustrated here:</p>
<ul>
<li>Hidden dependencies: the loop relies on many external objects (data frames, lists, output containers) that are not passed in as inputs.</li>
<li>Side effects: <code>dir.create()</code> and <code>setwd()</code> change the filesystem and global state, making runs order-dependent and harder to debug.</li>
<li>Repetition: near-identical blocks differ only in small parameter tweaks; this is a sign you want a worker function + parameters.</li>
<li>Magic numbers and unit conversions: values like <code>1:144</code>, <code>/1000</code>, and <code>tr = .6</code> are embedded without explanation.</li>
</ul>
<ol start="5" type="1">
<li>Poor documentation:</li>
</ol>
<pre><code>rewardblue=[-1 0 1];
rewardred=[-2 0 2];
rewardred=rewardred';
rewardblue=rewardblue';
visite=[];
alphachapeau{1}=0.1*ones(6,1);
crochetcl{1}=zeros(6,3);
cl{1}=zeros(6,3);
eta{1}=ones(6,1);
crochetcl{1}=zeros(6,3);
pcirconflexe{1}=ones(6,1)*[1/3 1/3 1/3];
mu{1}=1*ones(6,1);
pzero=(1/3)*ones(6,3);
%attention aux initialisations
muzero=1;
%muzero=ones(6,1);
muante{1}=0*ones(6,1);
entropy{1}=zeros(6,2);
responseconflict=[];
aleatory{1}=0.65*ones(6,1);</code></pre>
<ol start="6" type="1">
<li>Poor organization and documentation of script dependencies so that things have be run ‘just so’.</li>
</ol>
<p><em>script1.R</em></p>
<pre><code>source("import.R")

data2 &lt;- process_dataset(data1)</code></pre>
<p><em>script2.R</em></p>
<pre><code>source("script1.R")

data2 &lt;- convert_timecodes(data2)</code></pre>
<p><em>analysis.R</em></p>
<pre><code>source("script1.R")
#source("script2.R")
model_list &lt;- analyze_timecodes(data2) #But what if the time codes have to be converted in script2?!</code></pre>
</section>
<section id="documentation" class="level2">
<h2 class="anchored" data-anchor-id="documentation">Documentation</h2>
<p>Coding often reflects a series of multifactorial decisions that unfold over days or weeks. We often rely on short-term memory to keep track of code architecture in our heads from one day to the next. But when you get code to a reasonable state and move onto another part of the project, you will forget most, if not all, of your decisions and thinking. Simply put, once code is working, it’s easy to ‘dump it’ from your mind. This may be a matter of days or weeks, but you’re very unlikely to remember the context months later.</p>
<p>In this way, functional programming is great because it forces you to follow a paradigm that identifies sufficient inputs for a function as well as expected outputs.</p>
<p>But documentation is another key component. I would argue that more complex problems call for more verbose documentation, often in the form of inline comments. Example:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Example:</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Average Latent Class Probabilities for Most Likely Latent Class Membership (Row)</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="co">#by Latent Class (Column)</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="co">#           1        2</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="co">#  1   0.986    0.014</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="co">#  2   0.030    0.970</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="co">#A bit of a wonky section. Some notes:</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Rows represent those hard classified into that class.</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Rows sum to 1.0 and represent the summed average posterior probabilities of all the class assignment possibilities.</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Columns represent average posterior probability of being in class 1 for those hard classified as 1 or 2.</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) High diagonal indicates that hard classification matches posterior probability patterns.</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>countlist[[<span class="st">"avgProbs.mostLikely"</span>]] <span class="ot">&lt;-</span> <span class="fu">unlabeledMatrixExtract</span>(mostLikelyProbs, filename)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="refactoring" class="level2">
<h2 class="anchored" data-anchor-id="refactoring">Refactoring</h2>
<p>By the time you finish a hard data/programming problem, you will know so much more than when you began. You’ll have opinions about why you approached the problems in a certain way. You’ll also probably realize that your solution is more complicated than it needs to be. For example, you may write several functions, only to realize that they each contain the same data manipulation step as part of the set of procedures.</p>
<p>Refactoring can be time consuming, but it is <em>least</em> so when the code is relatively fresh and you still have a good short-term memory of how everything works. Again, evaluate how mission-critical this is, but do consider refactoring as an important final step of finishing a project.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>